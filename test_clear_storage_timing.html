<!DOCTYPE html>
<html>

<head>
    <title>Clear Storage Timing Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .test-result {
            margin: 10px 0;
            padding: 8px;
            border-radius: 4px;
        }

        .success {
            background: #d4edda;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
        }

        button {
            margin: 5px;
            padding: 8px 12px;
            cursor: pointer;
        }

        #log {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }

        .status-display {
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            background: #f8f9fa;
            font-family: monospace;
        }
    </style>
</head>

<body>
    <div class="test-container">
        <h1>Clear Storage Timing Test</h1>
        <p>This tests that storage summaries update immediately after clearing snapshots.</p>

        <div class="status-display">
            <div>Current Status:</div>
            <div id="current-status">Not initialized</div>
        </div>

        <div>
            <button onclick="initTest()">Initialize Test</button>
            <button onclick="createTestSnapshots()">Create Test Snapshots</button>
            <button onclick="clearAndTest()">Clear Storage & Test Updates</button>
            <button onclick="checkStorageStatus()">Check Storage Status</button>
        </div>

        <div id="log"></div>
    </div>

    <script type="module">
        let isInitialized = false

        function log(message, type = 'info') {
            const logEl = document.getElementById('log')
            const div = document.createElement('div')
            div.className = `test-result ${type}`
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`
            logEl.appendChild(div)
            logEl.scrollTop = logEl.scrollHeight
            console.log(message)
        }

        function updateStatus(status) {
            document.getElementById('current-status').textContent = status
        }

        window.initTest = async function () {
            try {
                log('Initializing test environment...', 'info')

                // Initialize unified storage
                const { initUnifiedStorage } = await import('./src/js/unified-storage.js')
                await initUnifiedStorage()
                log('✅ Unified storage initialized', 'success')

                // Setup minimal mocks
                window.getConfig = () => ({ id: 'timing-test', version: '1.0' })
                window.getConfigIdentity = () => 'timing-test@1.0'
                window.appendTerminal = (msg, type) => log(`Terminal: ${msg}`, 'info')
                window.activateSideTab = () => { }
                window.showConfirmModal = async () => true

                isInitialized = true
                updateStatus('Initialized')
                log('✅ Test initialization complete', 'success')

            } catch (error) {
                log(`❌ Initialization failed: ${error.message}`, 'error')
                updateStatus('Failed to initialize')
            }
        }

        window.createTestSnapshots = async function () {
            if (!isInitialized) {
                log('❌ Please initialize first', 'error')
                return
            }

            try {
                log('Creating test snapshots...', 'info')

                const { saveSnapshots } = await import('./src/js/unified-storage.js')
                const configId = 'timing-test@1.0'

                const snapshots = []
                for (let i = 1; i <= 3; i++) {
                    snapshots.push({
                        ts: Date.now() + i,
                        config: configId,
                        files: {
                            '/test.py': `print("Snapshot ${i}")`,
                            [`/data_${i}.txt`]: 'x'.repeat(1000 * i) // Different sizes
                        }
                    })
                }

                await saveSnapshots(configId, snapshots)

                // Check status immediately
                await checkStorageStatus()
                log('✅ Test snapshots created', 'success')

            } catch (error) {
                log(`❌ Failed to create snapshots: ${error.message}`, 'error')
            }
        }

        window.clearAndTest = async function () {
            if (!isInitialized) {
                log('❌ Please initialize first', 'error')
                return
            }

            try {
                log('Testing clear storage with immediate updates...', 'info')

                // Check status before clearing
                log('Status BEFORE clearing:', 'info')
                await checkStorageStatus()

                // Import and call the actual clear function from snapshots.js
                const { clearStorage } = await import('./src/js/snapshots.js')

                log('Calling clearStorage()...', 'info')
                await clearStorage()

                // Check status immediately after (this is the key test)
                log('Status IMMEDIATELY after clearStorage():', 'info')
                await checkStorageStatus()

                // Check again after a delay to see if it's consistent
                setTimeout(async () => {
                    log('Status after 500ms delay:', 'info')
                    await checkStorageStatus()
                }, 500)

                log('✅ Clear storage test completed', 'success')

            } catch (error) {
                log(`❌ Clear storage test failed: ${error.message}`, 'error')
            }
        }

        window.checkStorageStatus = async function () {
            try {
                const { getAllSnapshots } = await import('./src/js/unified-storage.js')
                const allData = await getAllSnapshots()

                let totalSnaps = 0
                let totalFiles = 0
                let totalSize = 0

                for (const data of allData) {
                    if (data.snapshots && Array.isArray(data.snapshots)) {
                        totalSnaps += data.snapshots.length
                        for (const snap of data.snapshots) {
                            const files = snap.files || {}
                            totalFiles += Object.keys(files).length
                            for (const content of Object.values(files)) {
                                totalSize += new TextEncoder().encode(String(content)).length
                            }
                        }
                    }
                }

                const sizeStr = totalSize < 1024 ? `${totalSize}B` :
                    totalSize < 1024 * 1024 ? `${Math.round(totalSize / 1024)}KB` :
                        `${(totalSize / (1024 * 1024)).toFixed(2)}MB`

                const status = `${totalSnaps} snaps • ${totalFiles} files • ${sizeStr}`
                updateStatus(status)
                log(`  Current storage: ${status}`, 'info')

                return { totalSnaps, totalFiles, totalSize }

            } catch (error) {
                log(`❌ Storage status check failed: ${error.message}`, 'error')
                updateStatus('Error checking storage')
                return null
            }
        }

        // Auto-initialize on page load
        window.addEventListener('load', () => {
            log('Clear Storage Timing Test loaded', 'info')
            log('Click "Initialize Test" to begin', 'info')
        })
    </script>
</body>

</html>