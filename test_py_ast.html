<!DOCTYPE html>
<html>

<head>
    <title>py-ast Library Test</title>
    <style>
        body {
            font-family: monospace;
            margin: 20px;
        }

        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ccc;
        }

        .success {
            background-color: #e8f5e8;
        }

        .error {
            background-color: #ffe8e8;
        }

        pre {
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .test-code {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <h1>py-ast Library Browser Compatibility Test</h1>

    <div id="import-test" class="section">
        <h3>Import Test</h3>
        <div id="import-result">Testing import...</div>
    </div>

    <div id="basic-test" class="section">
        <h3>Basic Parsing Test</h3>
        <div class="test-code">
            <strong>Test Code:</strong><br>
            def hello(name):<br>
            &nbsp;&nbsp;&nbsp;&nbsp;return f"Hello, {name}!"<br>
            <br>
            x = hello("World")<br>
            print(x)
        </div>
        <div id="basic-result">Waiting for import...</div>
    </div>

    <div id="advanced-test" class="section">
        <h3>Advanced Features Test</h3>
        <div class="test-code">
            <strong>Test Code:</strong><br>
            class Calculator:<br>
            &nbsp;&nbsp;&nbsp;&nbsp;def __init__(self, value=0):<br>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.value = value<br>
            <br>
            &nbsp;&nbsp;&nbsp;&nbsp;def add(self, x):<br>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.value += x<br>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return self<br>
            <br>
            calc = Calculator(10)<br>
            calc.add(5).add(3)<br>
            <br>
            # List comprehension<br>
            squares = [x**2 for x in range(5) if x % 2 == 0]
        </div>
        <div id="advanced-result">Waiting for import...</div>
    </div>

    <div id="ast-analysis-test" class="section">
        <h3>AST Analysis Features</h3>
        <div id="ast-analysis-result">Waiting for import...</div>
    </div>

    <script type="module">
        let pyAst = null;

        async function testImport() {
            const importDiv = document.getElementById('import-result');
            try {
                // Test import - use ESM build
                pyAst = await import('./node_modules/py-ast/dist/index.esm.js');
                console.log('py-ast imported:', pyAst);

                importDiv.innerHTML = '<span style="color: green;">✓ Successfully imported py-ast</span>';
                importDiv.parentElement.classList.add('success');

                // Test basic functionality
                runBasicTest();
                runAdvancedTest();
                runAstAnalysisTest();

            } catch (error) {
                console.error('Import error:', error);
                importDiv.innerHTML = `<span style="color: red;">✗ Import failed: ${error.message}</span>`;
                importDiv.parentElement.classList.add('error');
            }
        }

        function runBasicTest() {
            const resultDiv = document.getElementById('basic-result');
            const testCode = `def hello(name):
    return f"Hello, {name}!"

x = hello("World")
print(x)`;

            try {
                const ast = pyAst.parse(testCode);
                console.log('Basic AST:', ast);

                resultDiv.innerHTML = `
                    <span style="color: green;">✓ Successfully parsed basic Python code</span><br>
                    <strong>AST Root Type:</strong> ${ast.type}<br>
                    <strong>Body Length:</strong> ${ast.body ? ast.body.length : 'N/A'}<br>
                    <pre>${JSON.stringify(ast, null, 2)}</pre>
                `;
                resultDiv.parentElement.classList.add('success');
            } catch (error) {
                console.error('Basic test error:', error);
                resultDiv.innerHTML = `<span style="color: red;">✗ Basic parsing failed: ${error.message}</span>`;
                resultDiv.parentElement.classList.add('error');
            }
        }

        function runAdvancedTest() {
            const resultDiv = document.getElementById('advanced-result');
            const testCode = `class Calculator:
    def __init__(self, value=0):
        self.value = value
    
    def add(self, x):
        self.value += x
        return self

calc = Calculator(10)
calc.add(5).add(3)

# List comprehension
squares = [x**2 for x in range(5) if x % 2 == 0]`;

            try {
                const ast = pyAst.parse(testCode);
                console.log('Advanced AST:', ast);

                // Extract some useful information
                const classNodes = [];
                const functionNodes = [];
                const comprehensionNodes = [];

                function walkAST(node) {
                    if (!node || typeof node !== 'object') return;

                    if (node.type === 'ClassDef') classNodes.push(node);
                    if (node.type === 'FunctionDef') functionNodes.push(node);
                    if (node.type === 'ListComp') comprehensionNodes.push(node);

                    for (let key in node) {
                        if (Array.isArray(node[key])) {
                            node[key].forEach(walkAST);
                        } else if (typeof node[key] === 'object') {
                            walkAST(node[key]);
                        }
                    }
                }

                walkAST(ast);

                resultDiv.innerHTML = `
                    <span style="color: green;">✓ Successfully parsed advanced Python code</span><br>
                    <strong>Classes found:</strong> ${classNodes.length}<br>
                    <strong>Functions found:</strong> ${functionNodes.length}<br>
                    <strong>List comprehensions found:</strong> ${comprehensionNodes.length}<br>
                    <strong>Class names:</strong> ${classNodes.map(c => c.name).join(', ')}<br>
                    <strong>Function names:</strong> ${functionNodes.map(f => f.name).join(', ')}<br>
                `;
                resultDiv.parentElement.classList.add('success');
            } catch (error) {
                console.error('Advanced test error:', error);
                resultDiv.innerHTML = `<span style="color: red;">✗ Advanced parsing failed: ${error.message}</span>`;
                resultDiv.parentElement.classList.add('error');
            }
        }

        function runAstAnalysisTest() {
            const resultDiv = document.getElementById('ast-analysis-result');
            const testCode = `def analyze_me(x, y=10):
    """This function does analysis"""
    if x > 0:
        result = x + y
        for i in range(3):
            result *= 2
        return result
    else:
        return None`;

            try {
                const ast = pyAst.parse(testCode);

                // Detailed AST analysis for educational feedback
                const analysis = {
                    functions: [],
                    variables: new Set(),
                    controlFlow: [],
                    parameters: [],
                    returnStatements: 0
                };

                function analyzeNode(node, depth = 0) {
                    if (!node || typeof node !== 'object') return;

                    switch (node.type) {
                        case 'FunctionDef':
                            const func = {
                                name: node.name,
                                parameters: node.args ? node.args.args.map(arg => arg.arg) : [],
                                defaults: node.args ? node.args.defaults.length : 0,
                                docstring: null
                            };

                            // Check for docstring
                            if (node.body && node.body[0] && node.body[0].type === 'Expr' &&
                                node.body[0].value && node.body[0].value.type === 'Constant' &&
                                typeof node.body[0].value.value === 'string') {
                                func.docstring = node.body[0].value.value;
                            }

                            analysis.functions.push(func);
                            break;

                        case 'Name':
                            if (node.id) analysis.variables.add(node.id);
                            break;

                        case 'If':
                            analysis.controlFlow.push('if');
                            break;

                        case 'For':
                            analysis.controlFlow.push('for');
                            break;

                        case 'While':
                            analysis.controlFlow.push('while');
                            break;

                        case 'Return':
                            analysis.returnStatements++;
                            break;
                    }

                    // Recursively analyze child nodes
                    for (let key in node) {
                        if (Array.isArray(node[key])) {
                            node[key].forEach(child => analyzeNode(child, depth + 1));
                        } else if (typeof node[key] === 'object') {
                            analyzeNode(node[key], depth + 1);
                        }
                    }
                }

                analyzeNode(ast);

                resultDiv.innerHTML = `
                    <span style="color: green;">✓ Successfully performed AST analysis</span><br>
                    <strong>Functions:</strong> ${analysis.functions.length}<br>
                    <strong>Variables:</strong> ${analysis.variables.size}<br>
                    <strong>Control flow structures:</strong> ${analysis.controlFlow.length}<br>
                    <strong>Return statements:</strong> ${analysis.returnStatements}<br>
                    <br>
                    <strong>Function Details:</strong><br>
                    ${analysis.functions.map(f =>
                    `• ${f.name}(${f.parameters.join(', ')}${f.defaults > 0 ? ` +${f.defaults} defaults` : ''})`
                    + (f.docstring ? `<br>&nbsp;&nbsp;Docstring: "${f.docstring}"` : '')
                ).join('<br>')}<br>
                    <br>
                    <strong>Variables:</strong> ${Array.from(analysis.variables).join(', ')}<br>
                    <strong>Control structures:</strong> ${analysis.controlFlow.join(', ')}<br>
                `;
                resultDiv.parentElement.classList.add('success');

            } catch (error) {
                console.error('AST analysis error:', error);
                resultDiv.innerHTML = `<span style="color: red;">✗ AST analysis failed: ${error.message}</span>`;
                resultDiv.parentElement.classList.add('error');
            }
        }

        // Start the tests
        testImport();
    </script>
</body>

</html>