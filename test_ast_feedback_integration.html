<!DOCTYPE html>
<html>

<head>
    <title>AST Feedback Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .test-case {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
        }

        .result {
            margin: 10px 0;
            padding: 10px;
            border-left: 3px solid #007acc;
            background: #f8f9fa;
        }

        .error {
            border-left-color: #d73a49;
            background: #ffeaea;
        }

        .success {
            border-left-color: #28a745;
            background: #e8f5e9;
        }

        pre {
            background: #f6f8fa;
            padding: 10px;
            margin: 10px 0;
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <h1>AST Feedback Integration Test</h1>
    <p>This test verifies that the AST analyzer is properly integrated with the Clipy feedback system.</p>

    <div id="results"></div>

    <script type="module">
        import { resetFeedback, evaluateFeedbackOnEdit } from './src/js/feedback.js';

        const resultsDiv = document.getElementById('results');

        function addResult(title, success, message, data = null) {
            const div = document.createElement('div');
            div.className = 'test-case';
            div.innerHTML = `
                <h3>${title}</h3>
                <div class="result ${success ? 'success' : 'error'}">
                    ${message}
                    ${data ? `<pre>${JSON.stringify(data, null, 2)}</pre>` : ''}
                </div>
            `;
            resultsDiv.appendChild(div);
        }

        async function runTests() {
            console.log('Starting AST feedback integration tests...');

            // Test 1: Basic AST pattern configuration
            try {
                const config = {
                    feedback: [
                        {
                            id: 'test-function-exists',
                            title: 'Function Detection Test',
                            when: ['edit'],
                            pattern: {
                                type: 'ast',
                                target: 'code',
                                expression: 'function_exists:calculate_average'
                            },
                            message: 'Great! Found function: $2',
                            severity: 'info'
                        }
                    ]
                };

                resetFeedback(config);
                addResult('Test 1: Configuration', true, 'AST feedback configuration loaded successfully');

            } catch (error) {
                addResult('Test 1: Configuration', false, `Failed to configure AST feedback: ${error.message}`);
                return;
            }

            // Test 2: AST analysis on edit
            try {
                const testCode = `
def calculate_average(numbers):
    """Calculate the average of a list of numbers."""
    if not numbers:
        return 0
    return sum(numbers) / len(numbers)

def main():
    data = [1, 2, 3, 4, 5]
    avg = calculate_average(data)
    print(f"Average: {avg}")

if __name__ == "__main__":
    main()
`;

                const matches = await evaluateFeedbackOnEdit(testCode, '/main.py');

                if (matches && matches.length > 0) {
                    addResult('Test 2: AST Analysis', true,
                        `AST analysis found ${matches.length} match(es)`, matches);
                } else {
                    addResult('Test 2: AST Analysis', false,
                        'AST analysis did not find expected matches');
                }

            } catch (error) {
                addResult('Test 2: AST Analysis', false,
                    `AST analysis failed: ${error.message}`, error);
            }

            // Test 3: Multiple AST patterns
            try {
                const config = {
                    feedback: [
                        {
                            id: 'test-function-count',
                            title: 'Function Count Test',
                            when: ['edit'],
                            pattern: {
                                type: 'ast',
                                target: 'code',
                                expression: 'function_count'
                            },
                            message: 'Found $2 functions in your code',
                            severity: 'info'
                        },
                        {
                            id: 'test-docstring',
                            title: 'Docstring Test',
                            when: ['edit'],
                            pattern: {
                                type: 'ast',
                                target: 'code',
                                expression: 'has_docstring'
                            },
                            message: 'Great job using docstrings! Details: $1',
                            severity: 'info'
                        }
                    ]
                };

                resetFeedback(config);

                const testCode = `
def greet(name):
    """Greet someone by name."""
    return f"Hello, {name}!"

def farewell(name):
    return f"Goodbye, {name}!"
`;

                const matches = await evaluateFeedbackOnEdit(testCode, '/main.py');

                addResult('Test 3: Multiple AST Patterns', true,
                    `Multiple AST patterns processed: ${matches.length} total matches`, matches);

            } catch (error) {
                addResult('Test 3: Multiple AST Patterns', false,
                    `Multiple AST patterns test failed: ${error.message}`, error);
            }

            // Test 4: AST pattern with control flow analysis
            try {
                const config = {
                    feedback: [
                        {
                            id: 'test-control-flow',
                            title: 'Control Flow Test',
                            when: ['edit'],
                            pattern: {
                                type: 'ast',
                                target: 'code',
                                expression: 'control_flow:for_loop'
                            },
                            message: 'Found for loop usage: $1',
                            severity: 'info'
                        }
                    ]
                };

                resetFeedback(config);

                const testCode = `
numbers = [1, 2, 3, 4, 5]
total = 0
for num in numbers:
    total += num
print(f"Total: {total}")
`;

                const matches = await evaluateFeedbackOnEdit(testCode, '/main.py');

                addResult('Test 4: Control Flow Analysis', true,
                    `Control flow analysis completed: ${matches.length} matches`, matches);

            } catch (error) {
                addResult('Test 4: Control Flow Analysis', false,
                    `Control flow analysis failed: ${error.message}`, error);
            }

            console.log('AST feedback integration tests completed!');
        }

        // Initialize and run tests
        window.addEventListener('load', () => {
            runTests().catch(error => {
                console.error('Test suite failed:', error);
                addResult('Test Suite', false, `Test suite failed: ${error.message}`, error);
            });
        });

    </script>
</body>

</html>