<!DOCTYPE html>
<html>

<head>
    <title>py-ast Educational Features Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }

        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .success {
            background-color: #e8f5e8;
            border-color: #4caf50;
        }

        .error {
            background-color: #ffe8e8;
            border-color: #f44336;
        }

        .code-sample {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 3px;
            font-family: monospace;
        }

        .analysis-result {
            background: #f0f8ff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 3px;
        }

        .feedback-item {
            margin: 10px 0;
            padding: 10px;
            border-left: 4px solid #2196f3;
            background: #f9f9f9;
        }

        pre {
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        h2 {
            color: #333;
            border-bottom: 2px solid #333;
            padding-bottom: 5px;
        }

        h3 {
            color: #666;
        }

        .metric {
            display: inline-block;
            margin: 5px 15px 5px 0;
            padding: 5px 10px;
            background: #e3f2fd;
            border-radius: 3px;
        }
    </style>
</head>

<body>
    <h1>py-ast Educational Analysis Features</h1>
    <p>Testing educational feedback capabilities for Clipy's Python environment</p>

    <div id="function-analysis" class="test-section">
        <h2>1. Function Analysis</h2>
        <div class="code-sample">
            def calculate_grade(scores, weights=None):
            """Calculate weighted average grade"""
            if not scores:
            return 0

            if weights is None:
            weights = [1] * len(scores)

            total = sum(s * w for s, w in zip(scores, weights))
            return total / sum(weights)
        </div>
        <div id="function-result">Analyzing...</div>
    </div>

    <div id="variable-analysis" class="test-section">
        <h2>2. Variable Tracking</h2>
        <div class="code-sample">
            def process_data():
            data = [1, 2, 3, 4, 5]
            result = []

            for item in data:
            processed = item * 2
            if processed > 5:
            result.append(processed)

            final_result = sum(result)
            return final_result
        </div>
        <div id="variable-result">Analyzing...</div>
    </div>

    <div id="control-flow-analysis" class="test-section">
        <h2>3. Control Flow Analysis</h2>
        <div class="code-sample">
            def fibonacci(n):
            if n <= 1: return n elif n==2: return 1 else: a, b=0, 1 for i in range(2, n + 1): a, b=b, a + b return b
                </div>
                <div id="control-flow-result">Analyzing...</div>
        </div>

        <div id="code-quality-analysis" class="test-section">
            <h2>4. Code Quality Assessment</h2>
            <div class="code-sample">
                class Student:
                def __init__(self, name, age):
                self.name = name
                self.age = age
                self.grades = []

                def add_grade(self, grade):
                """Add a grade to the student's record"""
                if 0 <= grade <=100: self.grades.append(grade) else: raise ValueError("Grade must be between 0 and 100")
                    def get_average(self): if not self.grades: return 0 return sum(self.grades) / len(self.grades)
                    </div>
                    <div id="code-quality-result">Analyzing...</div>
            </div>

            <div id="educational-feedback" class="test-section">
                <h2>5. Educational Feedback Generation</h2>
                <div class="code-sample">
                    def buggy_function(numbers):
                    total = 0
                    for i in range(len(numbers)):
                    if numbers[i] > 0:
                    total = total + numbers[i]
                    average = total / len(numbers) # Potential division by zero
                    return average
                </div>
                <div id="educational-result">Analyzing...</div>
            </div>

            <script type="module">
                let pyAst = null;

                async function initializeLibrary() {
                    try {
                        pyAst = await import('./node_modules/py-ast/dist/index.esm.js');
                        console.log('py-ast initialized successfully');

                        // Run all analyses
                        analyzeFunctions();
                        analyzeVariables();
                        analyzeControlFlow();
                        analyzeCodeQuality();
                        generateEducationalFeedback();

                    } catch (error) {
                        console.error('Failed to initialize py-ast:', error);
                        document.body.innerHTML = `<h1>Error: ${error.message}</h1>`;
                    }
                }

                function analyzeFunctions() {
                    const code = `def calculate_grade(scores, weights=None):
    """Calculate weighted average grade"""
    if not scores:
        return 0
    
    if weights is None:
        weights = [1] * len(scores)
    
    total = sum(s * w for s, w in zip(scores, weights))
    return total / sum(weights)`;

                    try {
                        const ast = pyAst.parse(code);
                        const analysis = {
                            functions: [],
                            parameters: [],
                            defaults: [],
                            docstrings: [],
                            returnStatements: 0,
                            comprehensions: 0
                        };

                        pyAst.walk(ast, {
                            FunctionDef: (node) => {
                                const func = {
                                    name: node.name,
                                    parameters: node.args.args.map(arg => arg.arg),
                                    defaults: node.args.defaults.length,
                                    docstring: pyAst.getDocstring(node),
                                    lineno: node.lineno
                                };
                                analysis.functions.push(func);
                            },
                            Return: () => analysis.returnStatements++,
                            ListComp: () => analysis.comprehensions++,
                            GeneratorExp: () => analysis.comprehensions++
                        });

                        const func = analysis.functions[0];
                        const resultDiv = document.getElementById('function-result');
                        resultDiv.innerHTML = `
                    <div class="analysis-result">
                        <h3>Function: ${func.name}</h3>
                        <div class="metric">Parameters: ${func.parameters.length}</div>
                        <div class="metric">Defaults: ${func.defaults}</div>
                        <div class="metric">Returns: ${analysis.returnStatements}</div>
                        <div class="metric">Comprehensions: ${analysis.comprehensions}</div>
                        
                        <div class="feedback-item">
                            <strong>‚úì Good:</strong> Function has a descriptive docstring
                        </div>
                        <div class="feedback-item">
                            <strong>‚úì Good:</strong> Uses default parameter values appropriately
                        </div>
                        <div class="feedback-item">
                            <strong>‚úì Good:</strong> Includes input validation (empty scores check)
                        </div>
                        <div class="feedback-item">
                            <strong>‚úì Good:</strong> Uses comprehension for efficient calculation
                        </div>
                        
                        <p><strong>Parameters:</strong> ${func.parameters.join(', ')}</p>
                        <p><strong>Docstring:</strong> "${func.docstring || 'None'}"</p>
                    </div>
                `;
                        resultDiv.parentElement.classList.add('success');

                    } catch (error) {
                        const resultDiv = document.getElementById('function-result');
                        resultDiv.innerHTML = `<span style="color: red;">Error: ${error.message}</span>`;
                        resultDiv.parentElement.classList.add('error');
                    }
                }

                function analyzeVariables() {
                    const code = `def process_data():
    data = [1, 2, 3, 4, 5]
    result = []
    
    for item in data:
        processed = item * 2
        if processed > 5:
            result.append(processed)
    
    final_result = sum(result)
    return final_result`;

                    try {
                        const ast = pyAst.parse(code);
                        const variables = {
                            assigned: new Set(),
                            used: new Set(),
                            modified: new Set(),
                            scopes: []
                        };

                        pyAst.walk(ast, {
                            Assign: (node) => {
                                node.targets.forEach(target => {
                                    if (target.nodeType === 'Name') {
                                        variables.assigned.add(target.id);
                                    }
                                });
                            },
                            Name: (node) => {
                                if (node.ctx?.nodeType === 'Load') {
                                    variables.used.add(node.id);
                                }
                            },
                            Call: (node) => {
                                if (node.func?.nodeType === 'Attribute' &&
                                    node.func.attr === 'append' &&
                                    node.func.value?.nodeType === 'Name') {
                                    variables.modified.add(node.func.value.id);
                                }
                            }
                        });

                        const resultDiv = document.getElementById('variable-result');
                        resultDiv.innerHTML = `
                    <div class="analysis-result">
                        <h3>Variable Analysis</h3>
                        <div class="metric">Assigned: ${variables.assigned.size}</div>
                        <div class="metric">Used: ${variables.used.size}</div>
                        <div class="metric">Modified: ${variables.modified.size}</div>
                        
                        <p><strong>Assigned Variables:</strong> ${Array.from(variables.assigned).join(', ')}</p>
                        <p><strong>Used Variables:</strong> ${Array.from(variables.used).join(', ')}</p>
                        <p><strong>Modified Variables:</strong> ${Array.from(variables.modified).join(', ')}</p>
                        
                        <div class="feedback-item">
                            <strong>‚úì Good:</strong> All assigned variables are used
                        </div>
                        <div class="feedback-item">
                            <strong>‚úì Good:</strong> Descriptive variable names (data, result, processed)
                        </div>
                        <div class="feedback-item">
                            <strong>‚ö† Suggestion:</strong> Consider using list comprehension instead of loop + append
                        </div>
                    </div>
                `;
                        resultDiv.parentElement.classList.add('success');

                    } catch (error) {
                        const resultDiv = document.getElementById('variable-result');
                        resultDiv.innerHTML = `<span style="color: red;">Error: ${error.message}</span>`;
                        resultDiv.parentElement.classList.add('error');
                    }
                }

                function analyzeControlFlow() {
                    const code = `def fibonacci(n):
    if n <= 1:
        return n
    elif n == 2:
        return 1
    else:
        a, b = 0, 1
        for i in range(2, n + 1):
            a, b = b, a + b
        return b`;

                    try {
                        const ast = pyAst.parse(code);
                        const controlFlow = {
                            conditions: 0,
                            loops: 0,
                            branches: 0,
                            returns: 0,
                            complexity: 1  // Base complexity
                        };

                        pyAst.walk(ast, {
                            If: (node) => {
                                controlFlow.conditions++;
                                controlFlow.complexity++;
                                // Count elif/else branches
                                if (node.orelse.length > 0) {
                                    controlFlow.branches++;
                                    if (node.orelse[0]?.nodeType === 'If') {
                                        controlFlow.complexity++;
                                    }
                                }
                            },
                            For: () => {
                                controlFlow.loops++;
                                controlFlow.complexity++;
                            },
                            While: () => {
                                controlFlow.loops++;
                                controlFlow.complexity++;
                            },
                            Return: () => controlFlow.returns++
                        });

                        const resultDiv = document.getElementById('control-flow-result');
                        resultDiv.innerHTML = `
                    <div class="analysis-result">
                        <h3>Control Flow Analysis</h3>
                        <div class="metric">Conditions: ${controlFlow.conditions}</div>
                        <div class="metric">Loops: ${controlFlow.loops}</div>
                        <div class="metric">Returns: ${controlFlow.returns}</div>
                        <div class="metric">Complexity: ${controlFlow.complexity}</div>
                        
                        <div class="feedback-item">
                            <strong>‚úì Good:</strong> Handles base cases properly (n <= 1, n == 2)
                        </div>
                        <div class="feedback-item">
                            <strong>‚úì Good:</strong> Uses efficient iterative approach instead of recursion
                        </div>
                        <div class="feedback-item">
                            <strong>‚úì Good:</strong> Low cyclomatic complexity (${controlFlow.complexity})
                        </div>
                        <div class="feedback-item">
                            <strong>‚úì Good:</strong> Multiple return paths properly handled
                        </div>
                    </div>
                `;
                        resultDiv.parentElement.classList.add('success');

                    } catch (error) {
                        const resultDiv = document.getElementById('control-flow-result');
                        resultDiv.innerHTML = `<span style="color: red;">Error: ${error.message}</span>`;
                        resultDiv.parentElement.classList.add('error');
                    }
                }

                function analyzeCodeQuality() {
                    const code = `class Student:
    def __init__(self, name, age):
        self.name = name
        self.age = age
        self.grades = []
    
    def add_grade(self, grade):
        """Add a grade to the student's record"""
        if 0 <= grade <= 100:
            self.grades.append(grade)
        else:
            raise ValueError("Grade must be between 0 and 100")
    
    def get_average(self):
        if not self.grades:
            return 0
        return sum(self.grades) / len(self.grades)`;

                    try {
                        const ast = pyAst.parse(code);
                        const quality = {
                            classes: 0,
                            methods: 0,
                            docstrings: 0,
                            errorHandling: 0,
                            inputValidation: 0,
                            edgeCases: 0
                        };

                        pyAst.walk(ast, {
                            ClassDef: (node) => {
                                quality.classes++;
                                if (pyAst.getDocstring(node)) quality.docstrings++;
                            },
                            FunctionDef: (node) => {
                                quality.methods++;
                                if (pyAst.getDocstring(node)) quality.docstrings++;
                            },
                            Raise: () => quality.errorHandling++,
                            Compare: (node) => {
                                // Look for validation patterns
                                if (node.ops.some(op => ['Lt', 'LtE', 'Gt', 'GtE'].includes(op.nodeType))) {
                                    quality.inputValidation++;
                                }
                            },
                            If: (node) => {
                                // Check for edge case handling (empty checks, etc.)
                                if (node.test?.nodeType === 'UnaryOp' && node.test.op?.nodeType === 'Not') {
                                    quality.edgeCases++;
                                }
                            }
                        });

                        const resultDiv = document.getElementById('code-quality-result');
                        resultDiv.innerHTML = `
                    <div class="analysis-result">
                        <h3>Code Quality Assessment</h3>
                        <div class="metric">Classes: ${quality.classes}</div>
                        <div class="metric">Methods: ${quality.methods}</div>
                        <div class="metric">Docstrings: ${quality.docstrings}</div>
                        <div class="metric">Error Handling: ${quality.errorHandling}</div>
                        <div class="metric">Input Validation: ${quality.inputValidation}</div>
                        
                        <div class="feedback-item">
                            <strong>‚úì Excellent:</strong> Proper error handling with ValueError for invalid input
                        </div>
                        <div class="feedback-item">
                            <strong>‚úì Good:</strong> Input validation for grade range (0-100)
                        </div>
                        <div class="feedback-item">
                            <strong>‚úì Good:</strong> Edge case handling (empty grades list)
                        </div>
                        <div class="feedback-item">
                            <strong>‚úì Good:</strong> Method has descriptive docstring
                        </div>
                        <div class="feedback-item">
                            <strong>‚ö† Suggestion:</strong> Consider adding docstrings to all methods
                        </div>
                        <div class="feedback-item">
                            <strong>‚ö† Suggestion:</strong> Add class-level docstring to describe purpose
                        </div>
                    </div>
                `;
                        resultDiv.parentElement.classList.add('success');

                    } catch (error) {
                        const resultDiv = document.getElementById('code-quality-result');
                        resultDiv.innerHTML = `<span style="color: red;">Error: ${error.message}</span>`;
                        resultDiv.parentElement.classList.add('error');
                    }
                }

                function generateEducationalFeedback() {
                    const code = `def buggy_function(numbers):
    total = 0
    for i in range(len(numbers)):
        if numbers[i] > 0:
            total = total + numbers[i]
    average = total / len(numbers)  # Potential division by zero
    return average`;

                    try {
                        const ast = pyAst.parse(code);
                        const issues = [];
                        const suggestions = [];

                        pyAst.walk(ast, {
                            For: (node) => {
                                // Check for range(len(x)) pattern
                                if (node.iter?.nodeType === 'Call' &&
                                    node.iter.func?.id === 'range' &&
                                    node.iter.args?.[0]?.nodeType === 'Call' &&
                                    node.iter.args[0].func?.id === 'len') {
                                    suggestions.push({
                                        line: node.lineno,
                                        type: 'style',
                                        message: 'Consider using "for item in numbers:" instead of "for i in range(len(numbers)):"',
                                        explanation: 'Direct iteration is more Pythonic and less error-prone'
                                    });
                                }
                            },
                            BinOp: (node) => {
                                // Check for division operations
                                if (node.op?.nodeType === 'Div') {
                                    // Look for potential division by zero
                                    if (node.right?.nodeType === 'Call' &&
                                        node.right.func?.id === 'len') {
                                        issues.push({
                                            line: node.lineno,
                                            type: 'bug',
                                            severity: 'high',
                                            message: 'Potential division by zero error',
                                            explanation: 'If the input list is empty, len(numbers) will be 0, causing a runtime error'
                                        });
                                    }
                                }

                                // Check for x = x + y pattern
                                if (node.op?.nodeType === 'Add' &&
                                    node.left?.nodeType === 'Name') {
                                    suggestions.push({
                                        line: node.lineno,
                                        type: 'style',
                                        message: `Consider using "${node.left.id} += ..." instead of "${node.left.id} = ${node.left.id} + ..."`,
                                        explanation: 'Augmented assignment is more concise and clear'
                                    });
                                }
                            }
                        });

                        const resultDiv = document.getElementById('educational-result');
                        resultDiv.innerHTML = `
                    <div class="analysis-result">
                        <h3>Educational Feedback</h3>
                        
                        <h4 style="color: #d32f2f;">üêõ Issues Found (${issues.length})</h4>
                        ${issues.map(issue => `
                            <div class="feedback-item" style="border-left-color: #f44336; background: #ffebee;">
                                <strong>Line ${issue.line}:</strong> ${issue.message}<br>
                                <em>${issue.explanation}</em><br>
                                <strong>Severity:</strong> ${issue.severity}
                            </div>
                        `).join('')}
                        
                        <h4 style="color: #1976d2;">üí° Suggestions (${suggestions.length})</h4>
                        ${suggestions.map(suggestion => `
                            <div class="feedback-item" style="border-left-color: #2196f3;">
                                <strong>Line ${suggestion.line}:</strong> ${suggestion.message}<br>
                                <em>${suggestion.explanation}</em>
                            </div>
                        `).join('')}
                        
                        <div class="feedback-item" style="border-left-color: #4caf50; background: #e8f5e8;">
                            <strong>‚úì Teaching Moment:</strong> This function demonstrates common beginner patterns that can be improved for better Python style and safety.
                        </div>
                    </div>
                `;
                        resultDiv.parentElement.classList.add('success');

                    } catch (error) {
                        const resultDiv = document.getElementById('educational-result');
                        resultDiv.innerHTML = `<span style="color: red;">Error: ${error.message}</span>`;
                        resultDiv.parentElement.classList.add('error');
                    }
                }

                // Initialize when page loads
                initializeLibrary();
            </script>
</body>

</html>