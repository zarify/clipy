<!DOCTYPE html>
<html>

<head>
    <title>Test Read-Only Bug</title>
</head>

<body>
    <h1>Test Read-Only Bug</h1>
    <div id="output"></div>
    <script type="module">
        import { initializeVFS } from './src/js/vfs-client.js';

        async function test() {
            const output = document.getElementById('output');

            // Set up the exact config you provided
            const cfg = {
                "id": "test-read-write",
                "title": "Read-only testing",
                "version": "1.0",
                "description": "A demo script for authoring.",
                "instructions": "Testing read-only file settings.",
                "feedback": [],
                "tests": {
                    "groups": [],
                    "ungrouped": [],
                    "showGroupsToUsers": true
                },
                "starter": "\"Hello!\"\n",
                "files": {
                    "/main.py": "\"Hello!\"\n",
                    "read-only.txt": "This is a read-only file.",
                    "read-write.txt": "we can nuke this"
                },
                "fileReadOnlyStatus": {
                    "read-only.txt": true
                }
            };

            // Set global config so read-only checks work
            window.currentConfig = cfg;

            try {
                output.innerHTML += '<p>Initializing VFS...</p>';
                const { FileManager, mem } = await initializeVFS(cfg);

                output.innerHTML += '<p>VFS initialized. Now populating files from config...</p>';

                // Import setSystemWriteMode to enable system writes
                const { setSystemWriteMode } = await import('./src/js/vfs-client.js');

                // Enable system write mode to bypass read-only protection during initial file creation
                setSystemWriteMode(true);

                // Populate files from config (mimicking what app.js does)
                for (const [p, content] of Object.entries(cfg.files)) {
                    try {
                        await FileManager.write(p, String(content || ''));
                        output.innerHTML += '<p>Wrote file: ' + p + '</p>';
                    } catch (e) {
                        output.innerHTML += '<p>Failed to write file ' + p + ': ' + e.message + '</p>';
                    }
                }

                // Disable system write mode
                setSystemWriteMode(false);

                // List files in memory
                output.innerHTML += '<p>Files in mem: ' + Object.keys(mem).join(', ') + '</p>';

                // List files via FileManager
                const files = FileManager.list();
                output.innerHTML += '<p>Files via FileManager: ' + files.join(', ') + '</p>';

                // Try to read read-only.txt
                const roContent = FileManager.read('read-only.txt');
                output.innerHTML += '<p>read-only.txt content: ' + (roContent || 'NULL') + '</p>';

                // Try to read read-write.txt
                const rwContent = FileManager.read('read-write.txt');
                output.innerHTML += '<p>read-write.txt content: ' + (rwContent || 'NULL') + '</p>';

            } catch (e) {
                output.innerHTML += '<p>Error: ' + e.message + '</p>';
                console.error(e);
            }
        }

        test();
    </script>
</body>

</html>