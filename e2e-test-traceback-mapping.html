<!DOCTYPE html>
<html>

<head>
    <title>E2E Traceback Mapping Test</title>
    <style>
        body {
            font-family: monospace;
            margin: 20px;
        }

        .test-section {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px 0;
        }

        .terminal {
            background: #000;
            color: #0f0;
            padding: 10px;
            min-height: 100px;
            font-family: monospace;
        }

        .error {
            color: #f00;
        }

        .success {
            color: #0a0;
        }

        .debug {
            color: #888;
        }

        .result {
            background: #f0f0f0;
            padding: 10px;
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <h1>E2E Traceback Mapping Test</h1>

    <div class="test-section">
        <h2>Test Environment</h2>
        <div id="terminal-output" class="terminal"></div>
        <textarea id="code-editor" style="width: 100%; height: 100px;">print(z)</textarea>
        <br>
        <button id="run">Run Test</button>
        <button id="clear">Clear Terminal</button>
    </div>

    <div class="test-section">
        <h2>Test Results</h2>
        <div id="test-results"></div>
    </div>

    <div class="test-section">
        <h2>Debug Information</h2>
        <div id="debug-info"></div>
    </div>

    <script type="module">
        // Set up global state
        window.__ssg_terminal_event_log = [];
        window.__ssg_debug_logs = true;

        // Mock required functions
        window.$ = (id) => document.getElementById(id);
        window.logDebug = (...args) => {
            console.log('[DEBUG]', ...args);
            appendDebug(args.join(' '));
        };

        function appendDebug(text) {
            const debug = document.getElementById('debug-info');
            const div = document.createElement('div');
            div.className = 'debug';
            div.textContent = `[${new Date().toISOString()}] ${text}`;
            debug.appendChild(div);
        }

        function appendResult(text, isSuccess = true) {
            const results = document.getElementById('test-results');
            const div = document.createElement('div');
            div.className = isSuccess ? 'success' : 'error';
            div.textContent = text;
            results.appendChild(div);
        }

        // Import terminal module
        import('../js/terminal.js').then(terminalModule => {
            window.terminalModule = terminalModule;
            appendResult('‚úÖ Terminal module loaded successfully');

            // Import code-transform for mapping
            import('../js/code-transform.js').then(codeTransformModule => {
                window.codeTransformModule = codeTransformModule;
                appendResult('‚úÖ Code transform module loaded successfully');
                setupTest();
            }).catch(err => {
                appendResult(`‚ùå Failed to load code-transform module: ${err}`, false);
            });
        }).catch(err => {
            appendResult(`‚ùå Failed to load terminal module: ${err}`, false);
        });

        function setupTest() {
            // Set up execution context
            window.__ssg_last_mapped_event = { headerLines: 21 };
            window.__ssg_mapping_in_progress = false;
            window.__ssg_stderr_buffering = false;

            appendResult('‚úÖ Test environment set up');

            // Create terminal instance
            const terminal = window.terminalModule.createTerminal(window);
            window.terminalInstance = terminal;

            // Set up clear button
            document.getElementById('clear').addEventListener('click', () => {
                document.getElementById('terminal-output').innerHTML = '';
                document.getElementById('debug-info').innerHTML = '';
                window.__ssg_terminal_event_log = [];
            });

            // Set up test button
            document.getElementById('run').addEventListener('click', async () => {
                appendResult('üß™ Starting traceback mapping test...');
                await runTest();
            });

            appendResult('‚úÖ Event listeners set up - click "Run Test" to start');
        }

        async function runTest() {
            // Clear previous results
            const results = document.getElementById('test-results');
            results.innerHTML = '';
            window.__ssg_terminal_event_log = [];

            appendResult('üîÑ Running E2E traceback mapping test...');

            // Set up clean execution context
            window.__ssg_last_mapped_event = { headerLines: 21 };
            window.__ssg_mapping_in_progress = false;
            window.__ssg_stderr_buffering = false;

            appendDebug('Set execution context: headerLines=21');

            // Create problematic traceback
            const problematicTraceback = `Traceback (most recent call last):
  File "/main.py", line 22, in <module>
NameError: name 'z' is not defined`;

            appendDebug('Prepared problematic traceback');

            // Test the terminal mapping
            if (window.terminalInstance && window.terminalInstance.appendTerminal) {
                appendDebug('Calling appendTerminal with stdout...');
                window.terminalInstance.appendTerminal(problematicTraceback, 'stdout');

                // Wait for async processing
                await new Promise(resolve => setTimeout(resolve, 100));

                // Check results
                const terminalContent = document.getElementById('terminal-output').innerHTML;
                const hasMappedLine = terminalContent.includes('line 1');
                const hasOriginalLine = terminalContent.includes('line 22');

                appendResult(`üìä Terminal content: ${terminalContent}`);
                appendResult(`üéØ Has mapped line (line 1): ${hasMappedLine}`);
                appendResult(`üìç Has original line (line 22): ${hasOriginalLine}`);

                // Event log analysis
                appendDebug('=== EVENT LOG ===');
                window.__ssg_terminal_event_log.forEach((event, i) => {
                    appendDebug(`${i}: ${event.action} - ${event.text ? event.text.slice(0, 100) : 'no text'}`);
                });

                // Global state analysis
                appendDebug('=== GLOBAL STATE ===');
                appendDebug(`__ssg_last_mapped_event: ${JSON.stringify(window.__ssg_last_mapped_event)}`);
                appendDebug(`__ssg_mapping_in_progress: ${window.__ssg_mapping_in_progress}`);
                appendDebug(`__ssg_stderr_buffering: ${window.__ssg_stderr_buffering}`);

                if (hasMappedLine && !hasOriginalLine) {
                    appendResult('‚úÖ SUCCESS: Traceback mapping worked correctly!');
                } else if (hasOriginalLine && !hasMappedLine) {
                    appendResult('‚ùå FAILURE: Original line 22 shown, no mapping occurred', false);
                } else if (hasOriginalLine && hasMappedLine) {
                    appendResult('‚ö†Ô∏è  PARTIAL: Both lines present - mapping may be incomplete', false);
                } else {
                    appendResult('‚ùå FAILURE: No traceback content found', false);
                }
            } else {
                appendResult('‚ùå FAILURE: No terminal instance available', false);
            }
        }

        // Handle any uncaught errors
        window.addEventListener('error', (e) => {
            appendResult(`‚ùå ERROR: ${e.message}`, false);
            appendDebug(`Stack: ${e.error?.stack}`);
        });
    </script>
</body>

</html>