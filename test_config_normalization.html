<!DOCTYPE html>
<html>

<head>
    <title>Debug Author Config</title>
    <script type="module">
        import { validateAndNormalizeConfig } from './src/js/config.js'

        window.testConfigNormalization = async function () {
            console.log('=== Testing Config Normalization ===')

            // Test 1: Empty feedback should result in empty array, not legacy object
            const testConfig1 = {
                id: 'test1',
                title: 'Test Config 1',
                version: '1.0'
            }

            const normalized1 = validateAndNormalizeConfig(testConfig1)
            console.log('Test 1 - Empty feedback:')
            console.log('  Input feedback:', testConfig1.feedback)
            console.log('  Output feedback:', normalized1.feedback)
            console.log('  Is array:', Array.isArray(normalized1.feedback))
            console.log('  Length:', normalized1.feedback.length)

            // Test 2: Array feedback should be preserved
            const testConfig2 = {
                id: 'test2',
                title: 'Test Config 2',
                version: '1.0',
                feedback: [
                    {
                        id: 'f1',
                        title: 'Test Feedback',
                        when: ['edit'],
                        pattern: { type: 'regex', target: 'code', expression: 'print' },
                        message: 'Found print statement'
                    }
                ]
            }

            const normalized2 = validateAndNormalizeConfig(testConfig2)
            console.log('Test 2 - Array feedback:')
            console.log('  Input feedback length:', testConfig2.feedback.length)
            console.log('  Output feedback length:', normalized2.feedback.length)
            console.log('  First entry preserved:', normalized2.feedback[0].title)

            // Test 3: Legacy object feedback should be converted to array
            const testConfig3 = {
                id: 'test3',
                title: 'Test Config 3',
                version: '1.0',
                feedback: {
                    regex: [
                        {
                            id: 'legacy1',
                            title: 'Legacy Regex',
                            pattern: 'print',
                            message: 'Legacy message'
                        }
                    ],
                    ast: [
                        {
                            id: 'legacy2',
                            title: 'Legacy AST',
                            rule: 'function_def',
                            message: 'Legacy AST message'
                        }
                    ]
                }
            }

            const normalized3 = validateAndNormalizeConfig(testConfig3)
            console.log('Test 3 - Legacy object feedback:')
            console.log('  Input feedback type:', typeof testConfig3.feedback)
            console.log('  Output feedback type:', typeof normalized3.feedback, 'isArray:', Array.isArray(normalized3.feedback))
            console.log('  Output feedback length:', normalized3.feedback.length)
            console.log('  Entries:', normalized3.feedback.map(f => ({ id: f.id, title: f.title, type: f.pattern.type })))
        }

        console.log('Test function loaded. Run testConfigNormalization() to test.')
    </script>
</head>

<body>
    <h1>Debug Author Config</h1>
    <p>Open console and run <code>testConfigNormalization()</code></p>
</body>

</html>